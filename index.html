<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anamnese Terapêutica Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

       const firebaseConfig = {
  apiKey:"AIzaSyA0JuzYmLbJ9HCPXpfxGWQX19NsZenXO0s",
  authDomain:"meu-consultorio-568f0.firebaseapp.com",
  projectId: "meu-consultorio-568f0",
  storageBucket:  "meu-consultorio-568f0.firebasestorage.app",
  messagingSenderId: "121957844615",
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Exportar para o escopo global
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;

        // Autenticação Anónima para permitir gravação
        signInAnonymously(auth).catch(err => console.error("Erro Auth:", err));
    </script>
    <style>
        .form-section { display: none; }
        .form-section.active { display: block; }
        input, select, textarea { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; margin-top: 5px; }
        label { font-size: 14px; font-weight: 600; color: #334155; display: block; margin-top: 15px; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen py-10">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-indigo-600 mb-4"></div>
        <p>A guardar ficha do paciente...</p>
    </div>

    <div class="max-w-3xl mx-auto px-4">
        <div class="bg-indigo-700 text-white p-8 rounded-t-2xl shadow-lg">
            <h1 class="text-2xl font-bold">Ficha de Anamnese</h1>
            <p class="opacity-80">Preencha todos os campos com atenção.</p>
            <button onclick="verRespostas()" class="mt-4 text-xs bg-white/20 px-3 py-1 rounded">Ver Registos Salvos</button>
        </div>

        <form id="anamneseForm" class="bg-white p-8 rounded-b-2xl shadow-lg space-y-6">
            <!-- PASSO 1 -->
            <div class="form-section active" data-step="1">
                <h2 class="text-xl font-bold mb-4 text-indigo-700">1. Identificação</h2>
                <label>Nome Completo:</label>
                <input type="text" name="nome" required placeholder="Ex: Maria Silva">
                
                <label>Queixa Principal:</label>
                <textarea name="queixa" rows="3" placeholder="O que te trouxe aqui hoje?"></textarea>
            </div>

            <!-- PASSO 2 -->
            <div class="form-section" data-step="2">
                <h2 class="text-xl font-bold mb-4 text-indigo-700">2. Histórico</h2>
                <label>Como se sente emocionalmente hoje?</label>
                <select name="estado_emocional">
                    <option value="Equilibrado">Equilibrado(a)</option>
                    <option value="Ansioso">Ansioso(a)</option>
                    <option value="Triste">Triste / Desanimado(a)</option>
                    <option value="Irritado">Irritado(a) / Com Raiva</option>
                </select>
                
                <label>Observações adicionais:</label>
                <textarea name="obs" rows="3"></textarea>
            </div>

            <div class="flex justify-between pt-6">
                <button type="button" id="prevBtn" class="text-slate-400 hidden">Anterior</button>
                <button type="button" id="nextBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg ml-auto">Próximo</button>
                <button type="submit" id="submitBtn" class="bg-green-600 text-white px-8 py-2 rounded-lg hidden ml-auto">Finalizar e Gravar</button>
            </div>
        </form>

        <div id="success" class="hidden bg-white p-10 rounded-2xl shadow-xl text-center">
            <h2 class="text-2xl font-bold text-green-600">Dados Gravados!</h2>
            <p class="mt-2 text-slate-500">A ficha foi enviada com sucesso para o seu banco de dados.</p>
            <button onclick="location.reload()" class="mt-6 text-indigo-600 font-bold underline">Nova Resposta</button>
        </div>

        <div id="admin" class="hidden mt-6 bg-white p-6 rounded-xl border shadow">
            <h3 class="font-bold mb-4 border-b pb-2">Registos no Firebase:</h3>
            <div id="lista" class="text-sm space-y-2"></div>
        </div>
    </div>

    <script>
        let step = 1;
        const form = document.getElementById('anamneseForm');
        const sections = document.querySelectorAll('.form-section');

        function update() {
            sections.forEach((s, i) => s.classList.toggle('active', i === step-1));
            document.getElementById('prevBtn').classList.toggle('hidden', step === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', step === 2);
            document.getElementById('submitBtn').classList.toggle('hidden', step !== 2);
        }

        document.getElementById('nextBtn').onclick = () => { step++; update(); };
        document.getElementById('prevBtn').onclick = () => { step--; update(); };

        form.onsubmit = async (e) => {
            e.preventDefault();
            document.getElementById('loading').style.display = 'flex';
            
            try {
                const data = Object.fromEntries(new FormData(form).entries());
                data.data_criacao = new Date().toISOString();
                
                // Gravar na coleção 'pacientes' dentro do caminho padrão
                const col = window.collection(window.db, 'artifacts', 'meu-consultorio-568f0', 'public', 'data', 'pacientes');
                await window.addDoc(col, data);

                form.classList.add('hidden');
                document.getElementById('success').classList.remove('hidden');
            } catch (err) {
                alert("Erro ao gravar. Verifique se as chaves estão corretas.");
                console.error(err);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        };

        async function verRespostas() {
            const admin = document.getElementById('admin');
            const lista = document.getElementById('lista');
            admin.classList.toggle('hidden');
            if(admin.classList.contains('hidden')) return;

            lista.innerHTML = "A carregar...";
            try {
                const col = window.collection(window.db, 'artifacts', 'meu-consultorio-568f0', 'public', 'data', 'pacientes');
                const snap = await window.getDocs(col);
                lista.innerHTML = snap.empty ? "Nenhum registo." : "";
                snap.forEach(doc => {
                    const d = doc.data();
                    lista.innerHTML += `<div class="p-2 border-b"><b>${d.nome}</b> - ${new Date(d.data_criacao).toLocaleDateString()}</div>`;
                });
            } catch (e) { lista.innerHTML = "Erro ao ler dados."; }
        }
    </script>
</body>
</html>